<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2b2418" />
  <title>Monster Codex</title>

  <!-- Single-file version: no manifest/service worker required to run -->
  <style>
    :root{
      --bg: #0f0d09;
      --panel: #16120c;
      --paper: #efe3c7;
      --paper2:#e8d8b3;
      --ink:#1b160f;
      --muted:#8a7a62;
      --line:#3b3225;
      --accent:#c9a66b;
      --danger:#d46b6b;
      --shadow: rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.05), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, #0c0a07, #0f0d09 30%, #0c0a07);
      color:#eee;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      padding: 14px;
      padding-bottom: max(14px, env(safe-area-inset-bottom));
    }

    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.2));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .side-header{
      padding: 14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .brand svg{ width:28px;height:28px; }
    .brand h1{
      font-size: 16px;
      margin:0;
      letter-spacing:.6px;
    }
    .brand small{
      display:block;
      color: rgba(255,255,255,.6);
      margin-top:2px;
      font-weight:500;
    }

    .searchRow{ display:flex; gap:8px; align-items:center; }
    .searchRow input{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
    }
    .searchRow input:focus{
      border-color: rgba(201,166,107,.65);
      box-shadow: 0 0 0 3px rgba(201,166,107,.18);
    }

    .side-actions{ display:flex; gap:8px; margin-top:10px; }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:#fff;
      padding:10px 10px;
      border-radius: 12px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ border-color: rgba(255,255,255,.22); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(201,166,107,.35), rgba(0,0,0,.25));
      border-color: rgba(201,166,107,.65);
    }
    .btn.danger{
      border-color: rgba(212,107,107,.5);
      color:#ffd7d7;
    }

    .pages{
      padding: 8px;
      overflow:auto;
      min-height:0;
    }
    .pageItem{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      margin-bottom:8px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pageItem:hover{ border-color: rgba(255,255,255,.16); }
    .pageItem.active{
      border-color: rgba(201,166,107,.65);
      background: rgba(201,166,107,.12);
    }
    .pageItem .t{ font-weight:700; font-size: 14px; margin-bottom: 3px; }
    .pageItem .m{
      color: rgba(255,255,255,.65);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    .main{ min-height:0; display:flex; flex-direction:column; gap: 14px; }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .status{
      color: rgba(255,255,255,.75);
      font-size: 13px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(255,255,255,.12);
    }
    .dot.saved{ background: rgba(125, 214, 154, .55); border-color: rgba(125,214,154,.8); }
    .dot.saving{ background: rgba(201,166,107,.55); border-color: rgba(201,166,107,.8); }

    .bookWrap{ min-height:0; flex: 1; display:flex; align-items:stretch; justify-content:center; }
    .book{
      width:min(980px, 100%);
      min-height:0;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.25));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 25px 70px var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .bookHeader{
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .navBtns{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .bookHeader .hint{ color: rgba(255,255,255,.6); font-size: 12px; }

    .paperStage{
      position:relative;
      min-height:0;
      flex:1;
      padding: 16px;
      overflow:auto;
      background:
        radial-gradient(1000px 600px at 30% 10%, rgba(0,0,0,.08), transparent 55%),
        radial-gradient(900px 500px at 70% 30%, rgba(0,0,0,.06), transparent 60%);
    }

    .paper{
      position:relative;
      border-radius: 16px;
      padding: 18px 18px 16px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.06), transparent 25%),
        radial-gradient(700px 380px at 20% 10%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(800px 420px at 80% 20%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      color: var(--ink);
      border: 1px solid rgba(0,0,0,.2);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.35),
        0 30px 60px rgba(0,0,0,.30);
      overflow:hidden;
    }

    .paper:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(2px 2px at 10% 15%, rgba(0,0,0,.10), transparent 60%),
        radial-gradient(2px 2px at 70% 30%, rgba(0,0,0,.08), transparent 60%),
        radial-gradient(2px 2px at 30% 80%, rgba(0,0,0,.07), transparent 60%),
        radial-gradient(2px 2px at 85% 70%, rgba(0,0,0,.09), transparent 60%);
      opacity:.5;
      pointer-events:none;
      mix-blend-mode:multiply;
    }

    .paper.flipNext{ animation: flipNext .26s ease-in-out; }
    .paper.flipPrev{ animation: flipPrev .26s ease-in-out; }

    @keyframes flipNext{
      0%{ transform: perspective(1200px) rotateY(0deg) translateZ(0); }
      45%{ transform: perspective(1200px) rotateY(-12deg) translateZ(0); }
      100%{ transform: perspective(1200px) rotateY(0deg) translateZ(0); }
    }
    @keyframes flipPrev{
      0%{ transform: perspective(1200px) rotateY(0deg) translateZ(0); }
      45%{ transform: perspective(1200px) rotateY(12deg) translateZ(0); }
      100%{ transform: perspective(1200px) rotateY(0deg) translateZ(0); }
    }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    label{
      font-size: 12px;
      color: rgba(0,0,0,.65);
      font-weight:700;
      letter-spacing:.4px;
      text-transform:uppercase;
    }

    .titleInput{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.22);
      background: rgba(255,255,255,.65);
      outline:none;
      font-size: 18px;
      font-weight:800;
      color: var(--ink);
    }
    .titleInput:focus{
      border-color: rgba(70,50,25,.45);
      box-shadow: 0 0 0 3px rgba(201,166,107,.25);
    }

    .bodyInput{
      width:100%;
      min-height: 260px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.22);
      background: rgba(255,255,255,.58);
      outline:none;
      font-size: 15px;
      line-height: 1.5;
      color: var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
    }
    .bodyInput:focus{
      border-color: rgba(70,50,25,.45);
      box-shadow: 0 0 0 3px rgba(201,166,107,.25);
    }

    .divider{ height:1px; background: rgba(0,0,0,.16); margin: 14px 0; }

    .imgGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .imgCard{
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.35);
      overflow:hidden;
      position:relative;
    }
    .imgCard img{
      width:100%;
      height: 140px;
      object-fit:cover;
      display:block;
      background: rgba(0,0,0,.06);
    }
    .imgCard .imgActions{
      display:flex;
      justify-content:space-between;
      gap:8px;
      padding: 8px;
      align-items:center;
      font-size: 12px;
      color: rgba(0,0,0,.7);
    }
    .miniBtn{
      border:1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.55);
      border-radius: 10px;
      padding: 6px 8px;
      font-weight:700;
      cursor:pointer;
    }
    .miniBtn.danger{ border-color: rgba(212,107,107,.45); color: #7b1e1e; }

    .footerTools{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .note{ color: rgba(0,0,0,.6); font-size: 12px; margin-top: 10px; }

    @media (max-width: 880px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ order:2; }
      .main{ order:1; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="side-header">
        <div class="brand">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 20V6.5C6 5.12 7.12 4 8.5 4H18v16H8.5C7.12 20 6 18.88 6 17.5V8" stroke="rgba(201,166,107,.9)" stroke-width="1.6"/>
            <path d="M6 8h12" stroke="rgba(201,166,107,.6)" stroke-width="1.2"/>
            <path d="M9 11h6M9 14h7M9 17h5" stroke="rgba(0,0,0,.45)" stroke-width="1.2"/>
          </svg>
          <div>
            <h1>Monster Codex</h1>
            <small>Editable pages • Images • Search</small>
          </div>
        </div>

        <div class="searchRow">
          <input id="searchInput" placeholder="Search pages..." autocomplete="off" />
        </div>

        <div class="side-actions">
          <button class="btn primary" id="newPageBtn">+ New Page</button>
          <button class="btn" id="galleryBtn">Gallery</button>
        </div>
      </div>

      <div class="pages" id="pageList"></div>

      <div style="padding:10px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="exportBtn">Export Backup</button>
        <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
          Import Backup
          <input id="importFile" type="file" accept="application/json" style="display:none;">
        </label>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="status">
          <span class="dot saved" id="saveDot"></span>
          <span id="saveText">Saved</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn danger" id="deletePageBtn">Delete Page</button>
        </div>
      </div>

      <div class="bookWrap">
        <section class="book">
          <div class="bookHeader">
            <div class="navBtns">
              <button class="btn" id="prevBtn">◀ Prev</button>
              <button class="btn" id="nextBtn">Next ▶</button>
            </div>
            <div class="hint">Tip: iPhone Safari → Share → Add to Home Screen</div>
          </div>

          <div class="paperStage">
            <div class="paper" id="paper">
              <div class="row" style="justify-content:space-between;">
                <div><label>Page title</label></div>
                <div style="color: rgba(0,0,0,.55); font-size:12px; font-weight:700;">
                  <span id="pageMeta">—</span>
                </div>
              </div>

              <input class="titleInput" id="titleInput" placeholder="(Blank) e.g., The Rat Ahmetbehic" />

              <div class="divider"></div>

              <label>Entry text</label>
              <textarea class="bodyInput" id="bodyInput" placeholder="Write your entry here..."></textarea>

              <div class="divider"></div>

              <div class="row" style="justify-content:space-between; align-items:flex-end;">
                <div>
                  <label>Images</label>
                  <div class="note">Add images to this page. Stored in the app database.</div>
                </div>

                <label class="btn primary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
                  + Add Image
                  <input id="imageInput" type="file" accept="image/*" style="display:none;">
                </label>
              </div>

              <div style="height:10px"></div>
              <div class="imgGrid" id="imgGrid"></div>

              <div class="divider"></div>

              <label>Quick Tools</label>
              <div class="footerTools">
                <button class="btn" id="duplicateBtn">Duplicate Page</button>
                <button class="btn" id="clearBtn">Clear Text</button>
              </div>

              <div class="note">
                Saves on your device (IndexedDB). Export backups any time.
              </div>
            </div>
          </div>
        </section>
      </div>

      <div id="galleryPanel" style="display:none; background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:800;">All Images (Gallery)</div>
          <button class="btn" id="closeGalleryBtn">Close</button>
        </div>
        <div style="height:10px"></div>
        <div class="imgGrid" id="galleryGrid"></div>
      </div>
    </main>
  </div>

  <script>
    // ---------- Tiny IndexedDB helper ----------
    function openDB(name, version, upgrade) {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(name, version);
        req.onupgradeneeded = () => upgrade(req.result);
        req.onsuccess = () => resolve(wrapDB(req.result));
        req.onerror = () => reject(req.error);
      });
    }
    function wrapDB(db) {
      return {
        transaction(storeName, mode='readonly') { return db.transaction(storeName, mode); },
        async get(storeName, key) {
          return promisifyRequest(db.transaction(storeName).objectStore(storeName).get(key));
        },
        async getAll(storeName) {
          return promisifyRequest(db.transaction(storeName).objectStore(storeName).getAll());
        },
        async getAllFromIndex(storeName, indexName, query) {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const idx = store.index(indexName);
          return promisifyRequest(idx.getAll(query));
        },
        async put(storeName, value) {
          return promisifyRequest(db.transaction(storeName, 'readwrite').objectStore(storeName).put(value));
        },
        async delete(storeName, key) {
          return promisifyRequest(db.transaction(storeName, 'readwrite').objectStore(storeName).delete(key));
        },
      };
    }
    function promisifyRequest(req) {
      return new Promise((resolve, reject) => {
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    // ---------- App ----------
    const $ = (id) => document.getElementById(id);
    const els = {
      searchInput: $('searchInput'),
      pageList: $('pageList'),
      newPageBtn: $('newPageBtn'),
      galleryBtn: $('galleryBtn'),
      galleryPanel: $('galleryPanel'),
      galleryGrid: $('galleryGrid'),
      closeGalleryBtn: $('closeGalleryBtn'),

      prevBtn: $('prevBtn'),
      nextBtn: $('nextBtn'),

      paper: $('paper'),
      titleInput: $('titleInput'),
      bodyInput: $('bodyInput'),
      pageMeta: $('pageMeta'),
      imgGrid: $('imgGrid'),
      imageInput: $('imageInput'),

      deletePageBtn: $('deletePageBtn'),
      duplicateBtn: $('duplicateBtn'),
      clearBtn: $('clearBtn'),

      exportBtn: $('exportBtn'),
      importFile: $('importFile'),

      saveDot: $('saveDot'),
      saveText: $('saveText'),
    };

    const DB_NAME = 'monsterCodexDB';
    const DB_VER = 1;

    let db;
    let pages = [];
    let filteredPages = [];
    let activeIndex = 0;
    let activePage = null;
    let saveTimer = null;

    function uid() { return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`; }
    function fmtDate(ts) {
      const d = new Date(ts);
      return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }
    function setSaving(state) {
      if (state === 'saving') {
        els.saveDot.classList.remove('saved');
        els.saveDot.classList.add('saving');
        els.saveText.textContent = 'Saving…';
      } else {
        els.saveDot.classList.remove('saving');
        els.saveDot.classList.add('saved');
        els.saveText.textContent = 'Saved';
      }
    }
    function flipAnim(dir) {
      els.paper.classList.remove('flipNext', 'flipPrev');
      void els.paper.offsetWidth;
      els.paper.classList.add(dir === 'next' ? 'flipNext' : 'flipPrev');
    }
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, (c) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function shortPreview(text) {
      const s = text.replace(/\s+/g, ' ').trim();
      if (!s) return '—';
      return s.length > 22 ? s.slice(0, 22) + '…' : s;
    }

    async function initDB() {
      db = await openDB(DB_NAME, DB_VER, (dbi) => {
        if (!dbi.objectStoreNames.contains('pages')) {
          const store = dbi.createObjectStore('pages', { keyPath: 'id' });
          store.createIndex('updatedAt', 'updatedAt');
        }
        if (!dbi.objectStoreNames.contains('images')) {
          const store = dbi.createObjectStore('images', { keyPath: 'id' });
          store.createIndex('pageId', 'pageId');
          store.createIndex('createdAt', 'createdAt');
        }
      });
    }

    async function loadPages() {
      const all = await db.getAll('pages');
      all.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
      pages = all;

      if (pages.length === 0) {
        const starter = { id: uid(), title:'', body:'', createdAt: Date.now(), updatedAt: Date.now() };
        await db.put('pages', starter);
        pages = [starter];
      }
    }

    function renderPageList() {
      els.pageList.innerHTML = '';
      filteredPages.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'pageItem' + (activePage && p.id === activePage.id ? ' active' : '');
        item.innerHTML = `
          <div class="t">${escapeHtml(p.title || '(Blank page)')}</div>
          <div class="m">
            <span>${new Date(p.updatedAt || p.createdAt).toLocaleDateString()}</span>
            <span>${shortPreview(p.body || '')}</span>
          </div>
        `;
        item.addEventListener('click', () => {
          activeIndex = i;
          activePage = filteredPages[activeIndex];
          flipAnim('next');
          renderPageList();
          renderEditor();
        });
        els.pageList.appendChild(item);
      });
    }

    function renderEditorEmpty() {
      els.titleInput.value = '';
      els.bodyInput.value = '';
      els.pageMeta.textContent = 'No results';
      els.imgGrid.innerHTML = '';
    }

    async function renderImagesForActive() {
      els.imgGrid.innerHTML = '';
      if (!activePage) return;

      const images = await db.getAllFromIndex('images', 'pageId', activePage.id);
      images.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));

      for (const img of images) {
        const url = URL.createObjectURL(img.blob);
        const card = document.createElement('div');
        card.className = 'imgCard';
        card.innerHTML = `
          <img alt="Page image" src="${url}">
          <div class="imgActions">
            <span>${new Date(img.createdAt).toLocaleDateString()}</span>
            <button class="miniBtn danger">Remove</button>
          </div>
        `;
        card.querySelector('button').addEventListener('click', async () => {
          await db.delete('images', img.id);
          URL.revokeObjectURL(url);
          await renderImagesForActive();
          await renderGallery();
        });
        els.imgGrid.appendChild(card);
      }
    }

    async function renderEditor() {
      if (!activePage) return renderEditorEmpty();
      els.titleInput.value = activePage.title || '';
      els.bodyInput.value = activePage.body || '';
      els.pageMeta.textContent = `Updated: ${fmtDate(activePage.updatedAt || activePage.createdAt)}`;
      await renderImagesForActive();
    }

    function applyFilter() {
      const q = (els.searchInput.value || '').trim().toLowerCase();
      filteredPages = !q ? [...pages] : pages.filter(p => {
        const t = (p.title || '').toLowerCase();
        const b = (p.body || '').toLowerCase();
        return t.includes(q) || b.includes(q);
      });

      if (filteredPages.length === 0) {
        activeIndex = 0;
        activePage = null;
        renderPageList();
        renderEditorEmpty();
        return;
      }

      if (activePage) {
        const idx = filteredPages.findIndex(p => p.id === activePage.id);
        activeIndex = idx >= 0 ? idx : 0;
      } else {
        activeIndex = 0;
      }

      activePage = filteredPages[activeIndex];
      renderPageList();
      renderEditor();
    }

    function scheduleSave() {
      if (!activePage) return;
      setSaving('saving');
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        await saveActiveFromInputs();
        setSaving('saved');
      }, 450);
    }

    async function saveActiveFromInputs() {
      if (!activePage) return;

      const updated = {
        ...activePage,
        title: els.titleInput.value,
        body: els.bodyInput.value,
        updatedAt: Date.now(),
      };

      await db.put('pages', updated);

      const idxAll = pages.findIndex(p => p.id === activePage.id);
      if (idxAll >= 0) pages[idxAll] = updated;

      pages.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
      activePage = updated;

      applyFilter();
    }

    async function newPage() {
      const p = { id: uid(), title:'', body:'', createdAt: Date.now(), updatedAt: Date.now() };
      await db.put('pages', p);
      pages.unshift(p);
      els.searchInput.value = '';
      applyFilter();
      activeIndex = 0;
      activePage = filteredPages[0];
      flipAnim('next');
      renderPageList();
      renderEditor();
    }

    async function deleteActivePage() {
      if (!activePage) return;
      const ok = confirm('Delete this page? This cannot be undone.');
      if (!ok) return;

      await db.delete('pages', activePage.id);
      const imgs = await db.getAllFromIndex('images', 'pageId', activePage.id);
      for (const img of imgs) await db.delete('images', img.id);

      pages = pages.filter(p => p.id !== activePage.id);

      if (pages.length === 0) {
        await newPage();
        return;
      }

      els.searchInput.value = '';
      applyFilter();
      activePage = filteredPages[0] || null;
      activeIndex = 0;
      flipAnim('prev');
      renderPageList();
      renderEditor();
      await renderGallery();
    }

    async function duplicateActivePage() {
      if (!activePage) return;

      const p2 = {
        id: uid(),
        title: activePage.title ? `${activePage.title} (copy)` : '',
        body: activePage.body || '',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      await db.put('pages', p2);

      const imgs = await db.getAllFromIndex('images', 'pageId', activePage.id);
      for (const img of imgs) {
        await db.put('images', { id: uid(), pageId: p2.id, blob: img.blob, mime: img.mime, createdAt: Date.now() });
      }

      pages.unshift(p2);
      els.searchInput.value = '';
      applyFilter();
      activePage = filteredPages[0];
      activeIndex = 0;
      flipAnim('next');
      renderPageList();
      renderEditor();
      await renderGallery();
    }

    function clearText() {
      if (!activePage) return;
      const ok = confirm('Clear the text on this page?');
      if (!ok) return;
      els.bodyInput.value = '';
      scheduleSave();
    }

    function goPrev() {
      if (filteredPages.length <= 1) return;
      activeIndex = Math.max(0, activeIndex - 1);
      activePage = filteredPages[activeIndex];
      flipAnim('prev');
      renderPageList();
      renderEditor();
    }

    function goNext() {
      if (filteredPages.length <= 1) return;
      activeIndex = Math.min(filteredPages.length - 1, activeIndex + 1);
      activePage = filteredPages[activeIndex];
      flipAnim('next');
      renderPageList();
      renderEditor();
    }

    async function addImageFromFile(file) {
      if (!activePage || !file) return;
      if (!file.type.startsWith('image/')) { alert('Please choose an image file.'); return; }

      await db.put('images', { id: uid(), pageId: activePage.id, blob: file, mime: file.type, createdAt: Date.now() });

      await renderImagesForActive();
      await renderGallery();
    }

    async function renderGallery() {
      els.galleryGrid.innerHTML = '';
      const all = await db.getAll('images');
      all.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));

      for (const img of all) {
        const url = URL.createObjectURL(img.blob);
        const card = document.createElement('div');
        card.className = 'imgCard';
        card.innerHTML = `
          <img alt="Gallery image" src="${url}">
          <div class="imgActions">
            <span>${new Date(img.createdAt).toLocaleDateString()}</span>
            <button class="miniBtn">Go</button>
          </div>
        `;

        card.querySelector('button').addEventListener('click', () => {
          const page = pages.find(p => p.id === img.pageId);
          if (!page) return;
          els.searchInput.value = '';
          applyFilter();

          const idx = filteredPages.findIndex(p => p.id === page.id);
          activeIndex = idx >= 0 ? idx : 0;
          activePage = filteredPages[activeIndex];
          flipAnim('next');
          renderPageList();
          renderEditor();
          els.galleryPanel.style.display = 'none';
        });

        els.galleryGrid.appendChild(card);
      }
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    function dataURLToBlob(dataUrl) {
      const [meta, base64] = dataUrl.split(',');
      const mime = meta.match(/data:(.*);base64/)?.[1] || 'application/octet-stream';
      const bin = atob(base64);
      const arr = new Uint8Array(bin.length);
      for (let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);
      return new Blob([arr], { type: mime });
    }

    async function exportBackup() {
      const allPages = await db.getAll('pages');
      const allImages = await db.getAll('images');

      const images = [];
      for (const img of allImages) {
        const dataUrl = await blobToDataURL(img.blob);
        images.push({ id: img.id, pageId: img.pageId, mime: img.mime, createdAt: img.createdAt, dataUrl });
      }

      const backup = { version: 1, exportedAt: Date.now(), pages: allPages, images };
      download(`monster-codex-backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(backup, null, 2));
    }

    async function importBackup(file) {
      if (!file) return;
      const txt = await file.text();
      let backup;
      try { backup = JSON.parse(txt); }
      catch { alert('Invalid JSON backup file.'); return; }

      if (!backup.pages || !backup.images) { alert('Backup file is missing pages/images.'); return; }
      const ok = confirm('Import will MERGE into your current codex. Continue?');
      if (!ok) return;

      for (const p of backup.pages) {
        if (!p.id) p.id = uid();
        p.updatedAt = p.updatedAt || Date.now();
        p.createdAt = p.createdAt || Date.now();
        await db.put('pages', p);
      }

      for (const img of backup.images) {
        if (!img.pageId || !img.dataUrl) continue;
        await db.put('images', {
          id: img.id || uid(),
          pageId: img.pageId,
          mime: img.mime || 'image/*',
          createdAt: img.createdAt || Date.now(),
          blob: dataURLToBlob(img.dataUrl),
        });
      }

      await loadPages();
      applyFilter();
      await renderGallery();
    }

    function wireEvents() {
      els.searchInput.addEventListener('input', applyFilter);

      els.newPageBtn.addEventListener('click', newPage);

      els.prevBtn.addEventListener('click', goPrev);
      els.nextBtn.addEventListener('click', goNext);

      els.titleInput.addEventListener('input', scheduleSave);
      els.bodyInput.addEventListener('input', scheduleSave);

      els.imageInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        e.target.value = '';
        await addImageFromFile(file);
      });

      els.deletePageBtn.addEventListener('click', deleteActivePage);
      els.duplicateBtn.addEventListener('click', duplicateActivePage);
      els.clearBtn.addEventListener('click', clearText);

      els.galleryBtn.addEventListener('click', async () => {
        els.galleryPanel.style.display = 'block';
        await renderGallery();
        els.galleryPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      els.closeGalleryBtn.addEventListener('click', () => {
        els.galleryPanel.style.display = 'none';
      });

      els.exportBtn.addEventListener('click', exportBackup);
      els.importFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        e.target.value = '';
        await importBackup(file);
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') goPrev();
        if (e.key === 'ArrowRight') goNext();
      });
    }

    (async function main(){
      await initDB();
      await loadPages();
      wireEvents();

      filteredPages = [...pages];
      activePage = filteredPages[0];
      activeIndex = 0;
      renderPageList();
      await renderEditor();
      await renderGallery();
    })();
  </script>
</body>
</html>